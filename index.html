<!DOCTYPE html>
<html lang="pt-BR" data-font="sans" style="--app-height: 100vh; --transition-duration: 0.35s;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Minhas Notas</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Minhas Notas">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Slab:wght@400;700&family=Source+Code+Pro:wght@400;600&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            /* Font Variables */
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Roboto Slab', serif;
            --font-mono: 'Source Code Pro', monospace;
            --font-montserrat: 'Montserrat', sans-serif;

            /* Tema Padrão (Claro) */
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-dark: #1d1d1f; --text-light: #6e6e73; --border-color: #dcdcdc;
            --accent-color: #007aff; --accent-color-hover: #0056b3; --button-success: #34c759;
            --button-danger: #ff3b30; --button-whatsapp: #25d366; --radius: 16px;
            --shadow: rgba(0, 0, 0, 0.05);
            --app-height: 100vh;
            --transition-duration: 0.35s;
        }

        /* Tema Escuro */
        body[data-theme="dark"] {
            --bg-primary: #000000; --bg-secondary: #1c1c1e; --bg-tertiary: #2c2c2e;
            --text-dark: #ffffff; --text-light: #8e8e93; --border-color: #3a3a3c;
            --shadow: rgba(255, 255, 255, 0.08);
        }

        /* Temas Coloridos */
        body[data-theme="ocean"] { --bg-primary: #e0f7fa; --bg-secondary: #ffffff; --bg-tertiary: #e0f2f1; --text-dark: #004d40; --text-light: #00796b; --border-color: #b2dfdb; --accent-color: #26c6da; }
        body[data-theme="sunset"] { --bg-primary: #fff3e0; --bg-secondary: #ffffff; --bg-tertiary: #fff8e1; --text-dark: #4e342e; --text-light: #795548; --border-color: #ffccbc; --accent-color: #ff7043; }
        body[data-theme="forest"] { --bg-primary: #f1f8e9; --bg-secondary: #ffffff; --bg-tertiary: #f9fbe7; --text-dark: #33691e; --text-light: #558b2f; --border-color: #dcedc8; --accent-color: #9ccc65; }
        body[data-theme="plum"] { --bg-primary: #f3e5f5; --bg-secondary: #ffffff; --bg-tertiary: #f3e5f5; --text-dark: #4a148c; --text-light: #6a1b9a; --border-color: #e1bee7; --accent-color: #ab47bc; }
        body[data-theme="wine"] {
            --bg-primary: #4c1d2e; --bg-secondary: #5c2a3e; --bg-tertiary: #6b374e;
            --text-dark: #fcefee; --text-light: #e0c5d0; --border-color: #7a445d;
            --accent-color: #e75480;
        }

        /* Estilos de Fonte */
        html[data-font="sans"] body { font-family: var(--font-sans); }
        html[data-font="serif"] body { font-family: var(--font-serif); }
        html[data-font="mono"] body { font-family: var(--font-mono); }
        html[data-font="montserrat"] body { font-family: var(--font-montserrat); }

        /* --- LÓGICA DE ÍCONES --- */
        .icon-wrapper > * { display: none; }
        .icon-wrapper .icon-svg-outline, .icon-wrapper .icon-svg-duotone {
            width: 1em; height: 1em; vertical-align: -0.15em;
        }
        body:not([data-icon-theme]) .icon-wrapper [class*="fa-"],
        body[data-icon-theme="solid"] .icon-wrapper [class*="fa-"] { display: inline-block; }
        body[data-icon-theme="material"] .icon-wrapper .material-icons { display: inline-block; font-size: 22px; }
        body[data-icon-theme="outline"] .icon-wrapper .icon-svg-outline { display: inline-block; }
        body[data-icon-theme="duotone"] .icon-wrapper .icon-svg-duotone { display: inline-block; }

        /* --- ESTILOS GERAIS --- */
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        body.is-loading { opacity: 0; transition: none; }
        html, body { height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-primary); color: var(--text-dark); -webkit-user-select: none; user-select: none; }
        body { transition: opacity 0.3s, background-color var(--transition-duration), color var(--transition-duration); }
        .card, .app-screen, .header, .tab-bar, .settings-list-group, .nota-item, .actions-button {
            transition: background-color var(--transition-duration), color var(--transition-duration), border-color var(--transition-duration);
        }
        input, select, textarea, button {
            font-family: inherit;
            transition: background-color var(--transition-duration), color var(--transition-duration), border-color var(--transition-duration), box-shadow 0.2s;
        }
        .app-container { position: relative; width: 100%; height: var(--app-height); max-width: 680px; margin: 0 auto; background-color: var(--bg-primary); overflow: hidden; display: none; flex-direction: column; }
        .main-content { flex-grow: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .screen-wrapper { flex-grow: 1; position: relative; overflow: hidden; }
        .app-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); visibility: hidden; transition: transform var(--transition-duration) cubic-bezier(0.4, 0, 0.2, 1), visibility 0s linear var(--transition-duration); z-index: 1; display: flex; flex-direction: column; transform: translateY(20px); padding: 24px; overflow-y: auto; }
        .app-screen.active { visibility: visible; z-index: 2; transform: translateY(0); transition: transform var(--transition-duration) cubic-bezier(0.4, 0, 0.2, 1); }
        .header { padding: 16px 24px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); box-shadow: 0 1px 2px var(--shadow); position: relative; z-index: 10; }
        .header-title { font-size: 28px; font-weight: 700; color: var(--text-dark); margin: 0; opacity: 1; transform: translateY(0); transition: opacity var(--transition-duration), transform var(--transition-duration); }
        .header-title.title-changing { opacity: 0; transform: translateY(-5px); } 
        .header-action { background: none; border: none; color: var(--text-light); font-size: 20px; cursor: pointer; padding: 8px; display: flex; align-items: center; gap: 8px; }
        .tab-bar { z-index: 1001; display: flex; justify-content: space-around; align-items: center; background-color: rgba(255, 255, 255, 0.85); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); padding: 8px 0; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
        body[data-theme] .tab-bar { background-color: color-mix(in srgb, var(--bg-secondary) 85%, transparent); border-top-color: var(--border-color);}
        body[data-theme="dark"] .tab-bar { background-color: rgba(28, 28, 30, 0.85); }
        .tab-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-light); font-size: 10px; font-weight: 500; cursor: pointer; border: none; background: none; padding: 4px 6px; flex: 1; max-width: 16.66%; transition: color 0.2s; }
        .tab-item .icon-wrapper { font-size: 20px; }
        .tab-item.active { color: var(--accent-color) !important; }
        .card { background: var(--bg-secondary); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border-color); }
        .campo, .modal-campo { margin-bottom: 18px; }
        label { display: block; font-size: 13px; color: var(--text-light); margin: 0 0 8px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px; background: var(--bg-tertiary); color: var(--text-dark); }
        select option { background-color: var(--bg-secondary); color: var(--text-dark); }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); outline: 0; }
        .file-input-label { display: flex; align-items: center; justify-content: center; padding: 14px; border: 2px dashed var(--accent-color); border-radius: var(--radius); background: transparent; cursor: pointer; color: var(--accent-color); text-align: center; gap: 8px; font-weight: 600; transition: all 0.2s ease-in-out; }
        .file-input-label:hover { background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); border-style: solid; }
        #animation-speed-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-primary); border-radius: 4px; outline: none; }
        #animation-speed-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent-color); border-radius: 50%; cursor: pointer; transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        #animation-speed-slider::-webkit-slider-thumb:active { transform: scale(1.2); }
        #animation-speed-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--accent-color); border-radius: 50%; cursor: pointer; border: none; transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        #animation-speed-slider::-moz-range-thumb:active { transform: scale(1.2); }
        #animation-speed-label { display: flex; justify-content: space-between; align-items: center; }
        #animation-speed-value { font-weight: 600; color: var(--text-dark); background-color: var(--bg-primary); padding: 2px 8px; border-radius: 6px; font-size: 12px; }
        .reorder-list { list-style: none; padding: 0; margin: 0; border: 1px solid var(--border-color); border-radius: var(--radius); overflow: hidden; }
        .reorder-list-item { padding: 10px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background-color: var(--bg-secondary); }
        .reorder-list-item:last-child { border-bottom: none; }
        .reorder-list-item .name { display: flex; align-items: center; gap: 16px; font-weight: 500; }
        .reorder-list-item .actions button { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-light); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; }
        .reorder-list-item .actions button:disabled { opacity: 0.3; cursor: not-allowed; }
        .reorder-list-item .actions button:active { background: var(--accent-color); color: white; }

        /* --- LAYOUT DO TECLADO --- */
        #screen-anotacoes { display: flex; flex-direction: column; gap: 16px; padding-bottom: calc(24px + env(safe-area-inset-bottom)); transition: padding-bottom 0.2s ease-out; }
        #anotacoes-textarea { flex-grow: 1; height: 100%; resize: none; font-size: 16px; line-height: 1.6; padding: 20px; }
        .anotacoes-actions { display: flex; justify-content: center; gap: 10px; flex-shrink: 0; }
        .anotacoes-actions .actions-button { padding: 10px 16px; font-size: 14px; width: auto; flex-grow: 0; }

        .check-svg-icon { width: 1em; height: 1em; vertical-align: -0.15em; fill: currentColor; margin-right: 8px; }
        .sent-btn .check-svg-icon { margin-right: 0; }
        .fotos-enviadas-status .check-svg-icon { color: var(--button-success); }
        
        /* --- TELAS DE LOGIN/SEGURANÇA --- */
        #login-screen, #password-change-screen, #security-check-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; padding: 24px;
        }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        .login-box .icon { font-size: 48px; color: var(--text-light); margin-bottom: 24px; transition: color .4s ease, transform .4s ease; }
        .login-box h1 { font-size: 24px; color: var(--text-dark); margin-bottom: 8px; font-weight: 700; }
        .login-box p { font-size: 16px; color: var(--text-light); margin-bottom: 24px; }
        .login-box input { text-align: center; font-size: 18px; margin-top: 16px; }
        .login-box button { margin-top: 16px; background-color: var(--accent-color); }
        .login-box .error-message { color: var(--button-danger); font-size: 14px; height: 20px; margin-top: 8px; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake .82s cubic-bezier(.36, .07, .19, .97) both; }

        /* --- COMPONENTES MODAIS E LISTAS --- */
        .modal-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; align-items: center; justify-content: center; background-color: rgba(0,0,0,.4); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
        #confirm-modal { z-index: 10001; }
        .modal-screen.active { display: flex; }
        .modal-content { background-color: var(--bg-secondary); display: flex; flex-direction: column; border-radius: var(--radius); width: 100%; max-width: 680px; height: 100%; transform: translateY(20px); transition: transform var(--transition-duration) cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-screen.active .modal-content { transform: translateY(0); }
        .settings-list-group { list-style: none; padding: 0; margin: 0; background-color: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); overflow: hidden; }
        .settings-list-group:not(:first-child) { margin-top: 32px; }
        .settings-list-group li { border-bottom: 1px solid var(--border-color); }
        .settings-list-group li:last-child { border-bottom: none; }
        .settings-list-group a { display: flex; align-items: center; padding: 14px 16px; text-decoration: none; color: var(--text-dark); font-weight: 500; cursor: pointer; }
        .settings-list-group a:active { background-color: color-mix(in srgb, var(--text-dark) 5%, transparent); }
        .settings-list-group .icon { width: 32px; height: 32px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; margin-right: 16px; flex-shrink: 0; }
        .settings-list-group .fa-chevron-right { margin-left: auto; color: var(--text-light); opacity: .5; }
        #forn, .fornEdit { text-transform: uppercase; }
        .anexo-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        #fotos, #cameraInput, .edit-file-input { display: none; }
        #miniaturas-container, .miniaturas-container-edit { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; align-items: center; }
        .miniatura-wrapper { position: relative; }
        .miniatura-wrapper img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; }
        .miniatura-wrapper .not-found { width: 64px; height: 64px; border-radius: 8px; border: 1px dashed var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--text-light); background: var(--bg-primary); }
        .remove-foto { position: absolute; top: -8px; right: -8px; background: var(--button-danger); color: #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: none; }
        .nota-list { list-style: none; padding: 0; margin: 0; }
        .nota-item { background-color: var(--bg-secondary); border-radius: var(--radius); padding: 16px; border: 1px solid var(--border-color); margin-bottom: 16px; }
        .nota-item.nota-enviada .nota-info { color: var(--button-success); }
        .nota-info { font-weight: 600; font-size: 16px; color: var(--text-dark); margin-bottom: 4px; word-break: break-word; }
        .nota-data, .nota-detalhes { font-size: 13px; color: var(--text-light); margin-bottom: 8px; word-break: break-word; }
        .actions-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 16px; }
        .actions-row .actions-group { display: flex; gap: 8px; align-items: center; }
        .actions-row button { border: .5px solid var(--border-color); height: 38px; padding: 0 12px; border-radius: 8px; background: var(--bg-primary); color: var(--text-dark); font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .actions-row .icon-only { width: 38px; padding: 0; justify-content: center; font-size: 16px; }
        .actions-row .whatsapp-btn, .actions-row .sent-btn { background: var(--button-whatsapp); color: #fff; border: none; }
        .actions-row .sent-btn { background: var(--button-success); }
        .actions-row .edit-btn { color: var(--accent-color); }
        .actions-row .delete-btn { color: var(--button-danger); }
        .sem-fotos { font-size: 12px; color: var(--text-light); padding: 4px 8px; background: var(--bg-primary); border-radius: 6px; font-weight: 500; }
        .edit-panel, .checklist-container { overflow: hidden; max-height: 0; transition: max-height var(--transition-duration) ease-in-out, padding-top var(--transition-duration) ease-in-out, margin-top var(--transition-duration) ease-in-out; padding-top: 0; margin-top: 0; }
        .edit-panel.show, .checklist-container.show { max-height: 1000px; padding-top: 16px; margin-top: 16px; }
        .panel-content { padding: 16px; background-color: var(--bg-primary); border-radius: var(--radius); border-top: 1px solid var(--border-color); }
        .fotos-enviadas-status { text-align: center; color: var(--text-dark); font-weight: 500; padding: 10px; background-color: var(--bg-secondary); border-radius: var(--radius); }
        .progress-bar-container { width: 100%; background-color: var(--bg-primary); border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--button-success); width: 0; transition: width .5s ease; }
        .checklist-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .checklist-item input[type=checkbox] { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; accent-color: var(--accent-color); }
        .checklist-item label { margin: 0; font-weight: 400; color: var(--text-dark); cursor: pointer; }
        .manage-list, .manage-list li { list-style: none; padding: 0; margin: 0; }
        .manage-list { margin-top: 24px; border: 1px solid var(--border-color); border-radius: var(--radius); overflow: hidden; }
        .manage-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); font-weight: 500; }
        .manage-list li:last-child { border-bottom: none; }
        .manage-list button { background: none; border: none; font-size: 16px; color: var(--button-danger); cursor: pointer; padding: 4px; }
        #saida { width: 100%; height: 35vh; border: 2px dashed var(--border-color); border-radius: var(--radius); padding: 16px; background: var(--bg-secondary); color: var(--text-dark); font-size: 13px; line-height: 1.4; margin-bottom: 24px; }
        .actions-button { padding: 14px 20px; border: 0; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; color: #fff; width: 100%; }
        .actions { display: grid; gap: 12px; margin-top: 18px; }
        .toast { position: fixed; left: 50%; bottom: 80px; transform: translateX(-50%); background: rgba(44,62,80,.9); backdrop-filter: blur(5px); color: #fff; padding: 14px 22px; border-radius: 12px; display: none; font-size: 14px; z-index: 10002; animation: toastIn .3s ease; text-align: center; }
        .empty-state { text-align: center; color: var(--text-light); padding: 40px 0; }
        .modal-preview { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.9); justify-content: center; align-items: center; }
        .modal-preview-conteudo { max-width: 90%; max-height: 80%; object-fit: contain; }
        .modal-preview-fechar { position: fixed; top: 20px; right: 20px; color: #fff; font-size: 36px; background: rgba(0,0,0,.5); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background .2s; border: none; }
        .modal-preview-nav { position: fixed; top: 50%; transform: translateY(-50%); width: 100%; display: flex; justify-content: space-between; padding: 0 10px; pointer-events: none; }
        .modal-preview-nav button { background: rgba(0,0,0,.5); color: #fff; border: none; padding: 10px; font-size: 24px; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; transition: background .2s; pointer-events: all; }
        .modal-preview-bottom { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; align-items: center; }
        .modal-preview-action { background: var(--accent-color); color: #fff; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: var(--radius); display: flex; align-items: center; gap: 8px; }
        .modal-preview-action.delete { background: var(--button-danger); }
        #confirm-modal .modal-content { max-width: 380px; height: auto; padding: 24px; text-align: center; }
        #confirm-title { font-size: 20px; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        #confirm-message { color: var(--text-light); margin-bottom: 24px; line-height: 1.5; }
        .confirm-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* --- ANIMAÇÕES --- */
        @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes fa-spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: fa-spin 1s infinite linear; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-fade { from { background-color: rgba(0, 122, 255, .2); } to { background-color: transparent; } }
        .highlight-update { animation: highlight-fade 1.5s ease; }
        @keyframes sync-success { 0% { color: var(--text-light); } 50% { color: var(--button-success); transform: scale(1.2); } 100% { color: var(--text-light); transform: scale(1); } }
        .sync-success { animation: sync-success .8s ease-in-out; }

        /* --- LAYOUT DESKTOP --- */
        @media (min-width: 900px) {
            html, body { overflow: hidden; }
            .app-container { max-width: 100%; height: 100vh; display: flex; flex-direction: row; }
            .tab-bar { display: none; }
            .sidebar { display: flex; flex-direction: column; width: 250px; flex-shrink: 0; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); }
            .sidebar-header { display: flex; align-items: center; height: 70px; min-height: 70px; padding: 0 24px; font-size: 22px; font-weight: 700; border-bottom: 1px solid var(--border-color); color: var(--text-dark); }
            .sidebar-nav { list-style: none; padding: 0; margin: 16px 0; }
            .sidebar-item { display: flex; align-items: center; gap: 16px; padding: 14px 24px; text-decoration: none; color: var(--text-light); font-weight: 600; cursor: pointer; border-left: 4px solid transparent; transition: all .2s ease-in-out; }
            .sidebar-item:hover { background-color: var(--bg-primary); color: var(--text-dark); }
            .sidebar-item.active { color: var(--accent-color); border-left-color: var(--accent-color); background-color: var(--bg-primary); }
            .sidebar-item i, .sidebar-item svg { font-size: 20px; width: 24px; text-align: center; }
            .main-content .header { min-height: 70px; }
            .main-content .header-title { font-size: 22px; }
            .app-screen { padding: 24px 32px; }
            #screen-add .card { max-width: none; margin: 0; }
            .nota-list { display: block; }
            .modal-content { max-width: 580px; height: auto; max-height: 90vh; box-shadow: 0 10px 40px rgba(0,0,0,.2); }
        }
    </style>
</head>
<body class="is-loading" data-theme="light" data-icon-theme="solid">
    
    <div id="login-screen" style="display: none;">
        <div class="login-box">
            <div class="icon"><i class="fas fa-lock" id="login-icon"></i></div>
            <h1>Acesso Restrito</h1>
            <p>Por favor, insira suas credenciais para continuar.</p>
            <input type="email" id="email-input" placeholder="Seu e-mail" autocomplete="email">
            <input type="password" id="password-input" placeholder="Sua senha" autocomplete="current-password">
            <div id="error-message" class="error-message"></div>
            <button id="login-button" class="actions-button">Entrar</button>
        </div>
    </div>

    <div id="password-change-screen" style="display: none;">
        <div class="login-box">
            <div class="icon"><i class="fas fa-key"></i></div>
            <h1>Alterar Senha</h1>
            <p>Crie uma nova senha para sua conta.</p>
            <input type="password" id="new-password-input" placeholder="Nova Senha" autocomplete="new-password">
            <input type="password" id="confirm-password-input" placeholder="Confirmar Senha" autocomplete="new-password">
            <div id="password-error-message" class="error-message"></div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                <button id="cancel-password-change-btn" class="actions-button" style="background-color: var(--text-light);">Cancelar</button>
                <button id="save-new-password-btn" class="actions-button" style="background-color: var(--accent-color);">Salvar</button>
            </div>
        </div>
    </div>
    
    <div class="app-container" id="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">Minhas Notas</div>
            <ul id="sidebar-nav" class="sidebar-nav"></ul>
        </nav>

        <div class="main-content">
            <header class="header">
                <h1 id="main-header-title" class="header-title">Adicionar</h1>
                <div class="header-actions">
                    <button class="header-action" id="sync-btn" style="display: flex;">
                        <span class="icon-wrapper">
                            <i class="fa-solid fa-sync-alt"></i><span class="material-icons">sync</span>
                            <svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6"></path><path d="M22 11.5A10 10 0 0 1 3.2 7.2M2 12.5a10 10 0 0 1 18.8 4.2"></path></svg>
                            <svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M21.5 2v6h-6L21.5 2zM8.5 22v-6h-6L8.5 22z"></path><path d="M22 11.5A10 10 0 0 1 3.2 7.2M2 12.5a10 10 0 0 1 18.8 4.2"></path></svg>
                        </span>
                    </button>
                    <button class="header-action" id="close-btn" style="display: none;">
                        <span class="icon-wrapper">
                            <i class="fa-solid fa-times"></i><span class="material-icons">close</span>
                            <svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            <svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M18.364 7.05025C18.7565 6.65772 18.7565 6.02455 18.364 5.63203C17.9714 5.2395 17.3383 5.2395 16.9458 5.63203L12 10.5778L7.05421 5.63203C6.66169 5.2395 6.02852 5.2395 5.63599 5.63203C5.24347 6.02455 5.24347 6.65772 5.63599 7.05025L10.5818 12L5.63599 16.9458C5.24347 17.3383 5.24347 17.9715 5.63599 18.364C6.02852 18.7565 6.66169 18.7565 7.05421 18.364L12 13.4182L16.9458 18.364C17.3383 18.7565 17.9714 18.7565 18.364 18.364C18.7565 17.9715 18.7565 17.3383 18.364 16.9458L13.4182 12L18.364 7.05025Z"></path></svg>
                        </span>
                    </button>
                </div>
            </header>
            
            <div class="screen-wrapper">
                <div class="app-screen active" id="screen-add">
                    <div class="card">
                        <div class="campo"><label for="data">Data</label><input type="text" id="data" class="form-field" placeholder="dd/mm/aaaa" inputmode="decimal"></div>
                        <div class="campo"><label for="nf">NF</label><input type="text" id="nf" class="form-field" placeholder="Número da Nota Fiscal" inputmode="numeric"></div>
                        <div class="campo"><label for="venc">Vencimento</label><input type="text" id="venc" class="form-field" placeholder="dd/mm/aaaa" inputmode="decimal"></div>
                        <div class="campo"><label for="valor">Valor Total</label><input id="valor" type="text" class="form-field" placeholder="Ex: 1200,50" inputmode="decimal"></div>
                        <div class="campo"><label for="forn">Nome do Fornecedor</label><input type="text" id="forn" class="form-field" placeholder="Nome do fornecedor" list="fornecedores-sugeridos" value=""><datalist id="fornecedores-sugeridos"></datalist></div>
                        <div class="campo"><label for="obs">Observações</label><select id="obs" class="form-field"></select></div>
                        <div class="campo">
                            <label>Anexar Imagens</label>
                            <div class="anexo-actions">
                                <label for="fotos" class="file-input-label"><span class="icon-wrapper"><i class="fa-solid fa-image"></i><span class="material-icons">image</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M21 15l-5-5-4 4-4-4-5 5V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10zM8.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"></path><path d="M3 19.25V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zM21 15l-5-5-4 4-4-4-5 5V19h18v-4zM8.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"></path></svg></span> Selecionar</label>
                                <label for="cameraInput" class="file-input-label"><span class="icon-wrapper"><i class="fa-solid fa-camera"></i><span class="material-icons">photo_camera</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M9 2L7 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-3l-2-2H9zm3 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"></path><path d="M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path></svg></span> Câmera</label>
                            </div>
                            <input type="file" id="fotos" multiple accept="image/*">
                            <input type="file" id="cameraInput" accept="image/*" capture="environment">
                            <div id="miniaturas-container"></div>
                        </div>
                        <div class="actions">
                            <button id="salvarBtn" class="actions-button" style="background-color: var(--button-success);">
                                <span class="icon-wrapper"><i class="fa-solid fa-save"></i><span class="material-icons">save</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M17 21v-8H7v8h10zm-2-6h-2v4h2v-4z"></path><path d="M5 21h14a2 2 0 0 0 2-2V8l-6-6H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2zM7 13h10v8H7v-8zm5-7a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1z"></path></svg></span> Salvar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="app-screen" id="screen-manage">
                    <div id="lista-notas-pendentes" class="nota-list"></div>
                </div>
                
                <div class="app-screen" id="screen-export">
                    <textarea id="saida" readonly placeholder="O texto das notas pendentes aparecerá aqui..."></textarea>
                    <div class="actions">
                        <button id="exportar-btn" class="actions-button" style="background-color: var(--accent-color);"><span class="icon-wrapper"><i class="fa-solid fa-copy"></i><span class="material-icons">content_copy</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1h-2V4H4v9h1v-2z"></path><path d="M9 9h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V11a2 2 0 0 1 2-2zm0 2v10h10V11H9z"></path></svg></span> Copiar</button>
                        <button id="compartilhar-lista-btn" class="actions-button" style="background-color: var(--button-whatsapp);"><span class="icon-wrapper"><i class="fab fa-whatsapp"></i><span class="material-icons">share</span><svg class="icon-svg-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg><svg class="icon-svg-duotone" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M12 15V2l-4 4h3v9h2z"></path><path d="M20 12v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8H2v8a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4v-8h-2z"></path></svg></span> Compartilhar</button>
                        <button id="arquivar-tudo-btn" class="actions-button" style="background-color: var(--text-light);"><span class="icon-wrapper"><i class="fa-solid fa-archive"></i><span class="material-icons">archive</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M1 3h22v5H1V3zm9 9h4v2h-4v-2z"></path><path d="M21 8v13H3V8h18zm-2-7H5a2 2 0 0 0-2 2v3h20V3a2 2 0 0 0-2-2zM14 12h-4v-2h4v2z"></path></svg></span> Arquivar Tudo</button>
                    </div>
                </div>

                <div class="app-screen" id="screen-history">
                    <div id="lista-historico" class="nota-list"></div>
                    <div id="historico-actions" class="actions" style="display: none; margin-top: 24px;">
                        <button id="limpar-historico-btn" class="actions-button" style="background-color: var(--button-danger);"><span class="icon-wrapper"><i class="fa-solid fa-trash"></i><span class="material-icons">delete_sweep</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M10 11h4v6h-4v-6z"></path><path d="M3 6h18v2H3V6zm2 14V8h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2zm4-13V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v3H9zM10 17h4v-6h-4v6z"></path></svg></span> Limpar Histórico</button>
                    </div>
                </div>

                <div class="app-screen" id="screen-settings">
                    <ul class="settings-list-group">
                        <li><a data-screen="screen-fornecedores" data-title="Fornecedores"><i class="icon fa-solid fa-truck" style="background-color: #f5a623;"></i> Fornecedores <i class="fa-solid fa-chevron-right"></i></a></li>
                        <li><a data-screen="screen-pedidos" data-title="Pedidos e Recursos"><i class="icon fa-solid fa-box" style="background-color: #bd10e0;"></i> Pedidos e Recursos <i class="fa-solid fa-chevron-right"></i></a></li>
                        <li><a data-screen="screen-observacoes" data-title="Observações"><i class="icon fa-solid fa-comment-dots" style="background-color: #50e3c2;"></i> Observações <i class="fa-solid fa-chevron-right"></i></a></li>
                    </ul>
                    <ul class="settings-list-group">
                        <li><a data-screen="screen-personalizacao" data-title="Personalização"><i class="icon fa-solid fa-palette" style="background-color: #ff3b30;"></i> Personalização <i class="fa-solid fa-chevron-right"></i></a></li>
                        <li><a id="password-change-link"><i class="icon fa-solid fa-key" style="background-color: #4cd964;"></i> Alterar Senha <i class="fa-solid fa-chevron-right"></i></a></li>
                    </ul>
                     <ul class="settings-list-group">
                        <li><a id="logout-link"><i class="icon fa-solid fa-sign-out-alt" style="background-color: var(--text-light);"></i> Sair <i class="fa-solid fa-chevron-right"></i></a></li>
                    </ul>
                </div>

                <div class="app-screen" id="screen-fornecedores">
                    <div class="card">
                        <div class="modal-campo"><label>Nome do Fornecedor</label><input type="text" id="forn-manage" placeholder="Digite para adicionar..."></div>
                        <button id="add-fornecedor-btn" class="actions-button" style="background: var(--accent-color);"><span class="icon-wrapper"><i class="fa-solid fa-plus"></i><span class="material-icons">add</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-6V5a1 1 0 0 0-2 0v6H5a1 1 0 0 0 0 2h6v6a1 1 0 0 0 2 0v-6h6a1 1 0 0 0 0-2z"></path></svg></span> Adicionar Fornecedor</button>
                        <ul id="lista-fornecedores-manage" class="manage-list"></ul>
                    </div>
                </div>

                <div class="app-screen" id="screen-pedidos">
                    <div class="card">
                        <div class="modal-campo"><label>Nº do Pedido</label><input type="text" id="pedido-num" placeholder="Digite o número do pedido"></div>
                        <div class="modal-campo"><label>Recurso</label><select id="pedido-recurso"><option value="">Selecione...</option><option value="Santa Casa">Santa Casa</option><option value="CTI">CTI</option></select></div>
                        <button id="add-pedido-btn" class="actions-button" style="background: var(--accent-color); margin-top: 8px;"><span class="icon-wrapper"><i class="fa-solid fa-plus"></i><span class="material-icons">add</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-6V5a1 1 0 0 0-2 0v6H5a1 1 0 0 0 0 2h6v6a1 1 0 0 0 2 0v-6h6a1 1 0 0 0 0-2z"></path></svg></span> Adicionar</button>
                        <ul id="lista-pedidos" class="manage-list"></ul>
                    </div>
                </div>
                
                <div class="app-screen" id="screen-observacoes">
                    <div class="card">
                         <div class="modal-campo"><label>Nova Observação</label><input type="text" id="obs-manage" placeholder="Ex: C/C UPA"></div>
                         <button id="add-obs-btn" class="actions-button" style="background: var(--accent-color);"><span class="icon-wrapper"><i class="fa-solid fa-plus"></i><span class="material-icons">add</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-6V5a1 1 0 0 0-2 0v6H5a1 1 0 0 0 0 2h6v6a1 1 0 0 0 2 0v-6h6a1 1 0 0 0 0-2z"></path></svg></span> Adicionar Observação</button>
                         <ul id="lista-observacoes-manage" class="manage-list"></ul>
                    </div>
                </div>

                <div class="app-screen" id="screen-personalizacao">
                    <div class="card">
                        <div class="campo"> <label for="theme-select">Tema do Aplicativo</label> <select id="theme-select"> <option value="light">Claro</option> <option value="dark">Escuro</option> <option value="ocean">Oceano</option> <option value="sunset">Pôr do Sol</option> <option value="forest">Floresta</option> <option value="plum">Ameixa</option> <option value="wine">Vinho</option> </select> </div>
                        <div class="campo"> <label for="icon-theme-select">Estilo dos Ícones</label> <select id="icon-theme-select"> <option value="solid">Sólido (Padrão)</option> <option value="material">Material (Google)</option> <option value="outline">Contorno (Leve)</option> <option value="duotone">Duplo Tom</option> </select> </div>
                        <div class="campo"> <label for="font-select">Fonte do Aplicativo</label> <select id="font-select"> <option value="sans">Padrão (Inter)</option> <option value="serif">Serif (Roboto Slab)</option> <option value="mono">Mono (Source Code)</option> <option value="montserrat">Montserrat</option> </select> </div>
                        <div class="campo"> <label id="animation-speed-label" for="animation-speed-slider"> <span>Velocidade das Animações</span> <span id="animation-speed-value">Normal</span> </label> <input type="range" id="animation-speed-slider" min="0" max="3" step="1" value="2"> </div>
                        <div class="campo"> <label>Ordem dos Menus</label> <div id="menu-reorder-list" class="reorder-list"></div> </div>
                    </div>
                </div>

                <div class="app-screen" id="screen-anotacoes">
                    <textarea id="anotacoes-textarea" placeholder="Digite suas anotações aqui..."></textarea>
                    <div class="anotacoes-actions">
                        <button id="anotacoes-salvar-btn" class="actions-button" style="background-color: var(--button-success);"><span class="icon-wrapper"><i class="fa-solid fa-save"></i><span class="material-icons">save</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M17 21v-8H7v8h10zm-2-6h-2v4h2v-4z"></path><path d="M5 21h14a2 2 0 0 0 2-2V8l-6-6H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2zM7 13h10v8H7v-8zm5-7a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1z"></path></svg></span> Salvar</button>
                        <button id="anotacoes-copiar-btn" class="actions-button" style="background-color: var(--accent-color);"><span class="icon-wrapper"><i class="fa-solid fa-copy"></i><span class="material-icons">content_copy</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1h-2V4H4v9h1v-2z"></path><path d="M9 9h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V11a2 2 0 0 1 2-2zm0 2v10h10V11H9z"></path></svg></span> Copiar</button>
                        <button id="anotacoes-limpar-btn" class="actions-button" style="background-color: var(--button-danger);"><span class="icon-wrapper"><i class="fa-solid fa-trash"></i><span class="material-icons">delete</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M5 6h14v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6z"></path><path d="M9 4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2H9V4zM3 6h18v2H3V6z"></path></svg></span> Limpar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <nav id="tab-bar" class="tab-bar"></nav>
    </div>

    <div id="confirm-modal" class="modal-screen">
        <div class="modal-content">
            <h2 id="confirm-title"></h2>
            <p id="confirm-message"></p>
            <div class="confirm-actions">
                <button id="cancel-btn" class="actions-button" style="background-color: var(--text-light);">Cancelar</button>
                <button id="confirm-btn" class="actions-button">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modalPreview" class="modal-preview">
        <button class="modal-preview-fechar">×</button>
        <img class="modal-preview-conteudo" id="imgPreview">
        <div class="modal-preview-nav">
            <button id="prevBtn"><i class="fa-solid fa-chevron-left"></i></button>
            <button id="nextBtn"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div class="modal-preview-bottom">
            <button class="modal-preview-action" id="save-preview-btn"><i class="fa-solid fa-download"></i> Salvar</button>
            <button class="modal-preview-action delete" id="delete-preview-btn"><i class="fa-solid fa-trash-alt"></i> Excluir</button>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// =================================================================================
// INICIALIZAÇÃO E CONFIGURAÇÃO
// =================================================================================

// Suas chaves do Firebase. Elas são seguras para serem expostas aqui,
// pois a segurança é garantida pelas Regras do Firestore que configuramos.
const firebaseConfig = { 
    apiKey: "AIzaSyAwcvJNJhLZ4Wqcw4Wz44XJ9kIdtqKJeJg", 
    authDomain: "relacaonf.firebaseapp.com", 
    projectId: "relacaonf", 
    storageBucket: "relacaonf.appspot.com", 
    messagingSenderId: "773864981925", 
    appId: "1:773864981925:web:a4dadc51ec0a856832144c" 
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();

// --- ESTADO GLOBAL DO APLICATIVO ---
let currentUser = null;
let firestoreRefs = {}; // Armazenará as referências às coleções do usuário logado
let listeners = []; // Armazenará os listeners do Firestore para desligá-los no logout
let notasPendentes = [], historicoNotas = [], fotosAcumuladas = [];
let fotoAtualIndex = 0, fotosAtuaisParaPreview = [], fotoAtualContexto = {};
let isChecklistUpdate = false;
let isInitialLoad = true;

let appConfig = {
    personalizacao: { 
        theme: 'light', 
        iconTheme: 'solid', 
        font: 'sans', 
        animationSpeed: 2, 
        menuOrder: ['screen-add', 'screen-manage', 'screen-export', 'screen-history', 'screen-anotacoes', 'screen-settings'] 
    },
    anotacoes: '', 
    pedidosRecursos: {}, 
    fornecedores: [], 
    observacoes: ["C/C CTI", "C/C SANTA CASA", "Recurso Proprio Santa Casa", "Recurso Proprio CTI", "PAGO", "REMESSA"]
};

// --- CONSTANTES E UTILITÁRIOS ---
const DOM = {
    appContainer: document.getElementById('app-container'),
    loginScreen: document.getElementById('login-screen'),
    emailInput: document.getElementById('email-input'),
    passwordInput: document.getElementById('password-input'),
    loginButton: document.getElementById('login-button'),
    errorMessage: document.getElementById('error-message'),
    
    data: document.getElementById('data'),
    nf: document.getElementById('nf'),
    venc: document.getElementById('venc'),
    valor: document.getElementById('valor'),
    forn: document.getElementById('forn'),
    obs: document.getElementById('obs'),
    saida: document.getElementById('saida'),
    fotos: document.getElementById('fotos'),
    cameraInput: document.getElementById('cameraInput'),
    miniaturas: document.getElementById('miniaturas-container'),
    listaNotas: document.getElementById('lista-notas-pendentes'),
    listaHistorico: document.getElementById('lista-historico'),
    fornDatalist: document.getElementById('fornecedores-sugeridos'),
    listaPedidos: document.getElementById('lista-pedidos'),
    listaFornManage: document.getElementById('lista-fornecedores-manage'),
    fornManageInput: document.getElementById('forn-manage'),
    pedidoNumInput: document.getElementById('pedido-num'),
    pedidoRecursoSelect: document.getElementById('pedido-recurso'),
    listaObsManage: document.getElementById('lista-observacoes-manage'),
    obsManageInput: document.getElementById('obs-manage'),
    historicoActions: document.getElementById('historico-actions'),
};

const checkmarkSVG = `<svg class="check-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>`;
const spinnerIcon = `<span class="icon-wrapper"><i class="fa-solid fa-spinner fa-spin"></i></span>`;

const debounce = (func, delay) => {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
};

// Função para escapar HTML e prevenir XSS básico
const escapeHTML = str => 
    str.replace(/[&<>"']/g, match => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[match]));

// =================================================================================
// LÓGICA DE AUTENTICAÇÃO
// =================================================================================

auth.onAuthStateChanged(user => {
    if (user) {
        // Usuário está logado
        currentUser = user;
        DOM.loginScreen.style.display = 'none';
        DOM.appContainer.style.display = 'flex';
        iniciarAppParaUsuario();
    } else {
        // Usuário está deslogado
        currentUser = null;
        DOM.loginScreen.style.display = 'flex';
        DOM.appContainer.style.display = 'none';
        desligarListeners();
    }
});

function handleLogin() {
    const email = DOM.emailInput.value;
    const password = DOM.passwordInput.value;
    const loginButton = DOM.loginButton;
    
    if (!email || !password) {
        DOM.errorMessage.textContent = 'Por favor, preencha e-mail e senha.';
        return;
    }

    loginButton.disabled = true;
    loginButton.innerHTML = spinnerIcon + " Entrando...";
    DOM.errorMessage.textContent = '';

    auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
            let message = 'Ocorreu um erro. Tente novamente.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = 'E-mail ou senha incorretos.';
            }
            DOM.errorMessage.textContent = message;
            DOM.emailInput.classList.add('shake');
            setTimeout(() => DOM.emailInput.classList.remove('shake'), 820);
        })
        .finally(() => {
            loginButton.disabled = false;
            loginButton.textContent = 'Entrar';
        });
}

function handleLogout() {
    showConfirmModal({
        title: "Sair da Conta",
        message: "Tem certeza que deseja sair?",
        confirmText: "Sair",
        confirmClass: "danger",
        onConfirm: () => {
            auth.signOut().catch(error => {
                console.error("Erro ao sair:", error);
                toast("Erro ao tentar sair da conta.");
            });
        }
    });
}

function showPasswordChangeScreen() {
    document.getElementById('password-change-screen').style.display = 'flex';
}

function closePasswordChangeScreen() {
    const screen = document.getElementById('password-change-screen');
    screen.style.display = 'none';
    document.getElementById('new-password-input').value = '';
    document.getElementById('confirm-password-input').value = '';
    document.getElementById('password-error-message').textContent = '';
}

function handleSaveNewPassword() {
    const newPasswordInput = document.getElementById('new-password-input');
    const confirmPasswordInput = document.getElementById('confirm-password-input');
    const errorMessage = document.getElementById('password-error-message');
    
    const newPassword = newPasswordInput.value;

    if (newPassword.length < 6) {
        errorMessage.textContent = 'A senha deve ter no mínimo 6 caracteres.';
        return;
    }
    if (newPassword !== confirmPasswordInput.value) {
        errorMessage.textContent = 'As senhas não correspondem.';
        return;
    }
    
    errorMessage.textContent = '';
    
    currentUser.updatePassword(newPassword)
        .then(() => {
            toast('✓ Senha alterada com sucesso!');
            closePasswordChangeScreen();
        })
        .catch(error => {
            console.error("Erro ao alterar senha:", error);
            errorMessage.textContent = 'Erro ao alterar senha. Pode ser necessário fazer login novamente.';
        });
}

// =================================================================================
// LÓGICA PRINCIPAL DO APLICATIVO (APÓS LOGIN)
// =================================================================================

function iniciarAppParaUsuario() {
    // Configura as referências do Firestore para o usuário atual
    const userDocRef = firestore.collection('users').doc(currentUser.uid);
    firestoreRefs = {
        notas: userDocRef.collection('notas'),
        historico: userDocRef.collection('historico'),
        config: userDocRef.collection('config').doc('appSettings')
    };

    // Inicia os listeners para dados em tempo real
    iniciarListeners();
    
    // Configura a interface
    limparFormularioPrincipal(false);
}

function iniciarListeners() {
    desligarListeners(); // Garante que não haja listeners duplicados

    const configListener = firestoreRefs.config.onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            const currentOrder = appConfig.personalizacao.menuOrder;
            appConfig = { ...appConfig, ...data, personalizacao: { ...appConfig.personalizacao, ...(data.personalizacao || {}) } };
            if (!data.personalizacao || !data.personalizacao.menuOrder) {
                appConfig.personalizacao.menuOrder = currentOrder;
            }
        } else {
            firestoreRefs.config.set({ observacoes: appConfig.observacoes }, { merge: true });
        }
        popularDatalist();
        popularObservacoesList();
        popularListaPedidos();
        const anotacoesTextarea = document.getElementById('anotacoes-textarea');
        if (anotacoesTextarea.value !== appConfig.anotacoes) {
            anotacoesTextarea.value = appConfig.anotacoes || '';
        }
        aplicarPersonalizacoes();
        if (isInitialLoad) {
            document.body.classList.remove('is-loading');
            isInitialLoad = false;
        }
    }, error => {
        console.error("Erro no listener de configurações:", error);
        toast("Erro ao carregar configurações.");
        if (isInitialLoad) { document.body.classList.remove('is-loading'); isInitialLoad = false; }
    });

    const notasListener = firestoreRefs.notas.orderBy('dataCriacao', 'desc').onSnapshot(snapshot => {
        if (snapshot.metadata.hasPendingWrites && (isChecklistUpdate || snapshot.docChanges().some(c => c.type === 'modified'))) {
            isChecklistUpdate = false;
            notasPendentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return;
        }
        handleSnapshotChanges(snapshot);
    }, error => toast("Erro ao carregar dados."));

    const historicoListener = firestoreRefs.historico.orderBy('dataHistorico', 'desc').onSnapshot(snapshot => {
        historicoNotas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        popularListaHistorico();
    }, error => console.error("Erro ao carregar histórico:", error));

    listeners.push(configListener, notasListener, historicoListener);
}

function desligarListeners() {
    listeners.forEach(unsubscribe => unsubscribe());
    listeners = [];
}

// =================================================================================
// LÓGICA DE DADOS (NOTAS)
// =================================================================================
async function salvarNota() {
    const fornecedor = DOM.forn.value.trim().toUpperCase();
    if (!fornecedor) return toast("O campo 'Fornecedor' é obrigatório.");

    const salvarBtn = document.getElementById('salvarBtn');
    salvarBtn.disabled = true;
    salvarBtn.innerHTML = spinnerIcon + ' Salvando...';

    try {
        const photoIds = await Promise.all(fotosAcumuladas.map(file => savePhotoDB(generateUniqueId(), file)));
        const checklistInicial = Object.keys(checklistDefinition).reduce((acc, key) => ({ ...acc, [key]: false }), {});
        checklistInicial.tirarFoto = photoIds.length > 0;

        await firestoreRefs.notas.add({
            data: DOM.data.value.trim(),
            nf: DOM.nf.value.trim(),
            vencimento: DOM.venc.value.trim(),
            valor: DOM.valor.value.trim(),
            fornecedor,
            obs: DOM.obs.value.trim(),
            fotos: photoIds,
            enviada: false,
            dataCriacao: (new Date()).toISOString(),
            checklist: checklistInicial
        });

        await adicionarFornecedor(fornecedor, true);
        limparFormularioPrincipal(true);
        toast("✓ Nota salva com sucesso!");

    } catch (e) {
        console.error("Erro ao salvar nota:", e);
        toast("✕ Erro ao salvar a nota.");
    } finally {
        salvarBtn.disabled = false;
        limparFormularioPrincipal(false);
    }
}

async function deletarNota(id) {
    showConfirmModal({
        title: "Confirmar Exclusão",
        message: "Tem certeza que deseja excluir esta nota permanentemente? Esta ação não pode ser desfeita.",
        onConfirm: async () => {
            const nota = notasPendentes.find(n => n.id === id);
            if (nota?.fotos?.length > 0) {
                await Promise.all(nota.fotos.map(id => deletePhotoDB(id)));
            }
            await firestoreRefs.notas.doc(id).delete();
            toast("🗑️ Nota excluída!");
        }
    });
}

async function salvarEdicao(id) {
    const notaItem = document.querySelector(`div[data-note-id="${id}"]`);
    const data = {
        fornecedor: notaItem.querySelector(`.fornEdit`).value.trim().toUpperCase(),
        nf: notaItem.querySelector(`.nfEdit`).value.trim(),
        vencimento: notaItem.querySelector(`.vencEdit`).value.trim(),
        valor: notaItem.querySelector(`.valorEdit`).value.trim(),
        obs: notaItem.querySelector(`.obsEdit`).value.trim()
    };
    await firestoreRefs.notas.doc(id).update(data);
    await adicionarFornecedor(data.fornecedor, true);
    toast('✓ Nota editada e salva!');
    notaItem.querySelector('.edit-panel').classList.remove('show');
}

// ... (Restante da lógica de dados: compartilharNota, limpar, limparHistorico, etc.)
// A lógica interna dessas funções permanece a mesma, mas usando `firestoreRefs`.
// Exemplo:
async function limpar() {
    showConfirmModal({
        title: "Confirmar Arquivamento",
        message: `Arquivar ${notasPendentes.length} nota(s) no histórico? As fotos serão excluídas permanentemente.`,
        confirmText: "Arquivar",
        confirmClass: "success",
        onConfirm: async () => {
            if (notasPendentes.length === 0) return toast("Nenhuma nota para arquivar.");
            const batch = firestore.batch();
            for (const nota of notasPendentes) {
                const { id, ...notaData } = nota;
                notaData.dataHistorico = (new Date()).toLocaleString('pt-BR');
                batch.set(firestoreRefs.historico.doc(), notaData); // usa firestoreRefs
                batch.delete(firestoreRefs.notas.doc(id)); // usa firestoreRefs
                if (nota.fotos?.length > 0) {
                    await Promise.all(nota.fotos.map(photoId => deletePhotoDB(photoId)));
                }
            }
            await batch.commit();
            toast("Notas arquivadas no histórico.");
        }
    });
}

async function limparHistorico(){
    showConfirmModal({
        title:"Limpar TODO o Histórico?",
        message:"Esta ação é irreversível e apagará todos os registros do histórico. Deseja continuar?",
        onConfirm: async () => {
            if(historicoNotas.length === 0) return;
            const batch = firestore.batch();
            historicoNotas.forEach(nota => batch.delete(firestoreRefs.historico.doc(nota.id)));
            await batch.commit();
            toast("Histórico limpo com sucesso!");
        }
    });
}

// =================================================================================
// LÓGICA DA INTERFACE (UI)
// =================================================================================

document.addEventListener('DOMContentLoaded', () => {
    // Inicialização do App
    setAppHeight();
    window.addEventListener('resize', setAppHeight);
    setupKeyboardListener();
    openDB().catch(e => console.error("Não foi possível iniciar o DB de fotos.", e));
    
    // --- Adicionando Event Listeners ---
    
    // Autenticação
    DOM.loginButton.addEventListener('click', handleLogin);
    DOM.passwordInput.addEventListener('keyup', (e) => { if (e.key === "Enter") handleLogin(); });
    DOM.emailInput.addEventListener('keyup', (e) => { if (e.key === "Enter") handleLogin(); });
    document.getElementById('logout-link').addEventListener('click', handleLogout);
    document.getElementById('password-change-link').addEventListener('click', showPasswordChangeScreen);
    document.getElementById('save-new-password-btn').addEventListener('click', handleSaveNewPassword);
    document.getElementById('cancel-password-change-btn').addEventListener('click', closePasswordChangeScreen);
    
    // Navegação Principal
    document.getElementById('tab-bar').addEventListener('click', handleNavClick);
    document.getElementById('sidebar-nav').addEventListener('click', handleNavClick);
    document.getElementById('close-btn').addEventListener('click', () => switchToScreen('screen-settings', 'Ajustes'));
    document.getElementById('sync-btn').addEventListener('click', (e) => sincronizarManualmente(e.currentTarget));
    document.querySelectorAll('.settings-list-group a[data-screen]').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            switchToScreen(link.dataset.screen, link.dataset.title);
        });
    });

    // Tela de Adicionar Nota
    document.getElementById('salvarBtn').addEventListener('click', salvarNota);
    DOM.fotos.addEventListener('change', handleFileSelection);
    DOM.cameraInput.addEventListener('change', handleFileSelection);
    document.getElementById('data').addEventListener('input', (e) => formatarDataInput(e.target));
    document.getElementById('venc').addEventListener('input', (e) => formatarDataInput(e.target));
    document.getElementById('valor').addEventListener('blur', formatarValorBlur);

    // Tela de Exportar
    document.getElementById('exportar-btn').addEventListener('click', exportar);
    document.getElementById('compartilhar-lista-btn').addEventListener('click', compartilharLista);
    document.getElementById('arquivar-tudo-btn').addEventListener('click', limpar);

    // Tela de Histórico
    document.getElementById('limpar-historico-btn').addEventListener('click', limparHistorico);
    
    // Tela de Anotações
    document.getElementById('anotacoes-textarea').addEventListener('input', debounce(salvarAnotacoesAutomatico, 1000));
    document.getElementById('anotacoes-salvar-btn').addEventListener('click', salvarAnotacoesManual);
    document.getElementById('anotacoes-copiar-btn').addEventListener('click', copiarAnotacoes);
    document.getElementById('anotacoes-limpar-btn').addEventListener('click', limparAnotacoes);

    // Gerenciamento de Listas (Fornecedores, Pedidos, Observações)
    document.getElementById('add-fornecedor-btn').addEventListener('click', adicionarFornecedorManage);
    document.getElementById('lista-fornecedores-manage').addEventListener('click', handleManageListClick);
    document.getElementById('add-pedido-btn').addEventListener('click', adicionarPedido);
    document.getElementById('lista-pedidos').addEventListener('click', handleManageListClick);
    document.getElementById('add-obs-btn').addEventListener('click', adicionarObservacaoManage);
    document.getElementById('lista-observacoes-manage').addEventListener('click', handleManageListClick);
    
    // Personalização
    document.getElementById('theme-select').addEventListener('change', (e) => { appConfig.personalizacao.theme = e.target.value; salvarPersonalizacao(); });
    document.getElementById('icon-theme-select').addEventListener('change', (e) => { appConfig.personalizacao.iconTheme = e.target.value; salvarPersonalizacao(); });
    document.getElementById('font-select').addEventListener('change', (e) => { appConfig.personalizacao.font = e.target.value; salvarPersonalizacao(); });
    const speedSlider = document.getElementById('animation-speed-slider');
    speedSlider.addEventListener('input', (e) => { document.getElementById('animation-speed-value').textContent = speedTextMap[e.target.value]; });
    speedSlider.addEventListener('change', (e) => { appConfig.personalizacao.animationSpeed = parseInt(e.target.value, 10); salvarPersonalizacao(); });
    document.getElementById('menu-reorder-list').addEventListener('click', handleMenuReorderClick);

    // Modais e Previews
    document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.matches('#cancel-btn')) {
            closeAllModals();
        }
    });
    document.querySelector('.modal-preview-fechar').addEventListener('click', fecharPreview);
    document.getElementById('prevBtn').addEventListener('click', () => navegarFotos(-1));
    document.getElementById('nextBtn').addEventListener('click', () => navegarFotos(1));
    document.getElementById('save-preview-btn').addEventListener('click', salvarFotoPreview);
    document.getElementById('delete-preview-btn').addEventListener('click', excluirFotoPreview);
    
    // Event Delegation para listas dinâmicas
    DOM.listaNotas.addEventListener('click', handleNotasPendentesClick);
});

// =================================================================================
// CÓDIGO RESTANTE (SEM ALTERAÇÕES SIGNIFICATIVAS NA LÓGICA)
// =================================================================================

// Funções de manipulação do DOM, formatação, IndexedDB, etc., continuam aqui.
// A lógica interna delas não precisa mudar, apenas as chamadas ao Firestore
// que já foram atualizadas para usar `firestoreRefs`.
// ...
// (Colei o resto do JS aqui, fazendo as pequenas adaptações necessárias)

// O restante do código original JS vai aqui, com as seguintes alterações:
// - Substituir `notasCollection` por `firestoreRefs.notas`
// - Substituir `historicoCollection` por `firestoreRefs.historico`
// - Substituir `settingsDocRef` por `firestoreRefs.config`
// - Remover toda a lógica de senha antiga (`checkLogin`, `handleLogin` antigo, etc.)
// - Adicionar `handleNavClick` e outras funções de eventos que removemos do HTML.

function handleNavClick(e) {
    const target = e.target.closest('.tab-item, .sidebar-item');
    if (target && target.dataset.screen) {
        e.preventDefault();
        switchToScreen(target.dataset.screen, target.dataset.title);
    }
}

function handleFileSelection(e) {
    fotosAcumuladas.push(...Array.from(e.target.files));
    reconstruirMiniaturasAcumuladas();
    e.target.value = null; // Limpa o input para permitir selecionar o mesmo arquivo novamente
}

function handleManageListClick(e) {
    const button = e.target.closest('button');
    if (!button) return;
    
    const li = button.parentElement;
    const value = li.textContent.trim().split(' ')[0]; // Pega o valor principal (ID, nome, etc.)

    switch (e.currentTarget.id) {
        case 'lista-fornecedores-manage':
            deletarFornecedor(value);
            break;
        case 'lista-pedidos':
            deletarPedido(value);
            break;
        case 'lista-observacoes-manage':
            const obsValue = li.textContent.replace(/Excluir/,'').trim();
            deletarObservacao(obsValue);
            break;
    }
}

function handleMenuReorderClick(e) {
    const button = e.target.closest('button');
    if (!button) return;
    
    const item = button.closest('.reorder-list-item');
    const screenId = item.dataset.screenId;
    const direction = button.dataset.direction;
    
    moveMenuItem(screenId, direction);
}

function handleNotasPendentesClick(e) {
    const button = e.target.closest('button');
    if (!button) return;

    const notaItem = e.target.closest('.nota-item');
    const notaId = notaItem.dataset.noteId;

    if (button.matches('.progress-btn')) toggleChecklist(button, notaId);
    else if (button.matches('.whatsapp-btn')) compartilharNota(notaId);
    else if (button.matches('.edit-btn')) toggleEditPanel(button, notaId);
    else if (button.matches('.delete-btn')) deletarNota(notaId);
    else if (button.matches('.checklist-item input')) {
         const checkbox = button;
         const tarefa = checkbox.id.split('-')[1];
         atualizarChecklist(notaId, tarefa, checkbox.checked);
    }
}

const setAppHeight = () => {
    document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
};
const setupKeyboardListener = () => {
    if (!('visualViewport' in window)) { return; }
    const notesScreen = document.getElementById('screen-anotacoes');
    window.visualViewport.addEventListener('resize', () => {
        if (!notesScreen.classList.contains('active')) return;
        const keyboardHeight = window.innerHeight - window.visualViewport.height;
        const bottomPadding = 24;
        if (keyboardHeight > 100) {
            notesScreen.style.paddingBottom = `${keyboardHeight + bottomPadding}px`;
            setTimeout(() => notesScreen.scrollTop = notesScreen.scrollHeight, 100);
        } else {
            notesScreen.style.paddingBottom = '';
        }
    });
};
const menuDetails = { 'screen-add': { icon: 'fa-solid fa-plus-circle', material: 'add_circle', title: 'Adicionar', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/><path d="M13 11h3a1 1 0 0 1 0 2h-3v3a1 1 0 0 1-2 0v-3H8a1 1 0 0 1 0-2h3V8a1 1 0 0 1 2 0v3z"/></svg>` }, 'screen-manage': { icon: 'fa-solid fa-tasks', material: 'article', title: 'Gerenciar', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm2 15H8v-2h8v2zm0-4H8v-2h8v2zM14 9V4l5 5h-5z"/></svg>` }, 'screen-export': { icon: 'fa-solid fa-file-export', material: 'ios_share', title: 'Exportar', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M12 15V3l4 5h-3v7h-2z"/><path d="M5 15v4a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-4h2v4a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4v-4h2z"/></svg>` }, 'screen-history': { icon: 'fa-solid fa-history', material: 'history', title: 'Histórico', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M3.51 15A9 9 0 1 0 12 3a9 9 0 0 0-8.49 6H1l6 6V9H1a10 10 0 0 1 .1-2.06z"/><path d="M12 7v5l3.5 2-1 1.73L11 13.73V7h1z"/></svg>` }, 'screen-anotacoes': { icon: 'fa-solid fa-sticky-note', material: 'note_alt', title: 'Anotações', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.5z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M20 9h-7V2l7 7z"/><path d="M6 2h7.5L20 8.5V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>` }, 'screen-settings': { icon: 'fa-solid fa-cog', material: 'settings', title: 'Ajustes', outlineSvg: `<svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`, duotoneSvg: `<svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33A1.65 1.65 0 0 0 14 20.91V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1.51-1A1.65 1.65 0 0 0 7.4 19.4l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33A1.65 1.65 0 0 0 10 3.09V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1.51 1 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>` }, };
const screenParentMap = { 'screen-personalizacao': 'screen-settings', 'screen-fornecedores': 'screen-settings', 'screen-pedidos': 'screen-settings', 'screen-observacoes': 'screen-settings' };
const speedTextMap = { 0: 'Off', 1: 'Lenta', 2: 'Normal', 3: 'Rápida' };
const speedValueMap = { 0: '0s', 1: '0.6s', 2: '0.35s', 3: '0.2s' };
const checklistDefinition = { tirarFoto: "Tirar Foto", entradaSistema: "Entrada no sistema", produtosTransferidos: "Produtos transferidos", fotosNoServidor: "Fotos no servidor", cotacaoNoServidor: "Cotação no Servidor", notaEscaneada: "Nota Escaneada", estaNaPlanilha: "Está na planilha", cotacaoAnexada: "Cotação Anexada", notaCarimbada: "Nota Carimbada" };
const DB_NAME = 'notasdb-fotos', DB_VERSION = 1;
let db;

function openDB() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e => e.target.result.createObjectStore('fotos', { keyPath: 'id' }); r.onsuccess = e => { db = e.target.result; resolve(db) }; r.onerror = e => reject(e.target.errorCode) }) }
function generateUniqueId() { return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}` }
function savePhotoDB(id, file) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos'], 'readwrite').objectStore('fotos').put({ id, file }).onsuccess = () => resolve(id) }) }
function getPhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos']).objectStore('fotos').get(id).onsuccess = e => resolve(e.target.result ? e.target.result.file : null) }) }
function deletePhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos'], 'readwrite').objectStore('fotos').delete(id).onsuccess = () => resolve() }) }

// Todas as outras funções utilitárias e de UI vão aqui...
// ... (O código é longo, mas a lógica foi mantida e adaptada para o novo fluxo)
function aplicarPersonalizacoes() { const { theme, iconTheme, font, animationSpeed, menuOrder } = appConfig.personalizacao; document.documentElement.setAttribute('data-font', font); document.body.setAttribute('data-theme', theme); document.body.setAttribute('data-icon-theme', iconTheme); document.documentElement.style.setProperty('--transition-duration', speedValueMap[animationSpeed]); document.querySelector('#theme-select').value = theme; document.querySelector('#icon-theme-select').value = iconTheme; document.querySelector('#font-select').value = font; document.querySelector('#animation-speed-slider').value = animationSpeed; document.getElementById('animation-speed-value').textContent = speedTextMap[animationSpeed]; reordenarMenusDOM(menuOrder || Object.keys(menuDetails)); popularListaReordenar(); const currentActiveScreen = document.querySelector('.app-screen.active'); if (currentActiveScreen) { const screenId = currentActiveScreen.id; const parentScreenId = screenParentMap[screenId] || screenId; document.querySelectorAll('.tab-item, .sidebar-item').forEach(item => { item.classList.toggle('active', item.dataset.screen === parentScreenId); }); } }
function reordenarMenusDOM(order) { const tabBar = document.getElementById('tab-bar'); const sidebarNav = document.getElementById('sidebar-nav'); tabBar.innerHTML = ''; sidebarNav.innerHTML = ''; order.forEach(screenId => { const details = menuDetails[screenId]; if (details) { const iconHTML = `<span class="icon-wrapper"><i class="${details.icon}"></i><span class="material-icons">${details.material}</span>${details.outlineSvg || ''}${details.duotoneSvg || ''}</span>`; const tabButton = document.createElement('button'); tabButton.className = 'tab-item'; tabButton.dataset.screen = screenId; tabButton.dataset.title = details.title; tabButton.innerHTML = `${iconHTML}<span>${details.title}</span>`; tabBar.appendChild(tabButton); const sidebarLi = document.createElement('li'); const sidebarA = document.createElement('a'); sidebarA.className = 'sidebar-item'; sidebarA.dataset.screen = screenId; sidebarA.dataset.title = details.title; sidebarA.innerHTML = `${iconHTML}<span>${details.title}</span>`; sidebarLi.appendChild(sidebarA); sidebarNav.appendChild(sidebarLi); } }); }
function popularListaReordenar() { const list = document.getElementById('menu-reorder-list'); list.innerHTML = ''; const order = appConfig.personalizacao.menuOrder; order.forEach((screenId, index) => { const details = menuDetails[screenId]; if (details) { const li = document.createElement('div'); li.className = 'reorder-list-item'; li.dataset.screenId = screenId; li.innerHTML = ` <div class="name"> <span class="icon-wrapper"><i class="${details.icon}"></i><span class="material-icons">${details.material}</span>${details.outlineSvg || ''}${details.duotoneSvg || ''}</span> <span>${details.title}</span> </div> <div class="actions"> <button data-direction="up" ${index === 0 ? 'disabled' : ''}><i class="fa-solid fa-arrow-up"></i></button> <button data-direction="down" ${index === order.length - 1 ? 'disabled' : ''}><i class="fa-solid fa-arrow-down"></i></button> </div> `; list.appendChild(li); } }); }
function moveMenuItem(screenId, direction) { const order = appConfig.personalizacao.menuOrder; const index = order.indexOf(screenId); if (index === -1) return; if (direction === 'up' && index > 0) { [order[index], order[index - 1]] = [order[index - 1], order[index]]; } else if (direction === 'down' && index < order.length - 1) { [order[index], order[index + 1]] = [order[index + 1], order[index]]; } salvarPersonalizacao(); }
function salvarPersonalizacao() { if (!firestoreRefs.config) return; firestoreRefs.config.set({ personalizacao: appConfig.personalizacao }, { merge: true }).catch(error => console.error("Erro ao salvar personalização: ", error)); }
const salvarAnotacoesAutomatico = () => { if (!firestoreRefs.config) return; appConfig.anotacoes = document.getElementById('anotacoes-textarea').value; firestoreRefs.config.set({ anotacoes: appConfig.anotacoes }, { merge: true }).catch(error => { console.error("Erro no salvamento automático:", error); }); };
const salvarAnotacoesManual = () => { if (!firestoreRefs.config) return; const saveButton = document.getElementById('anotacoes-salvar-btn'); const originalContent = saveButton.innerHTML; saveButton.disabled = true; saveButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...'; appConfig.anotacoes = document.getElementById('anotacoes-textarea').value; firestoreRefs.config.set({ anotacoes: appConfig.anotacoes }, { merge: true }).then(() => { saveButton.innerHTML = `${checkmarkSVG} Salvo!`; setTimeout(() => { saveButton.innerHTML = originalContent; saveButton.disabled = false; }, 1500); }).catch(error => { toast('Erro ao salvar.'); saveButton.innerHTML = originalContent; saveButton.disabled = false; console.error(error); }); };
function copiarAnotacoes() { const copyButton = document.getElementById('anotacoes-copiar-btn'); const originalContent = copyButton.innerHTML; const texto = document.getElementById('anotacoes-textarea').value; if (!texto.trim()) { toast("Nada para copiar."); return; } copyButton.disabled = true; navigator.clipboard.writeText(texto).then(() => { copyButton.innerHTML = `${checkmarkSVG} Copiado!`; setTimeout(() => { copyButton.innerHTML = originalContent; copyButton.disabled = false; }, 1500); }).catch(() => { toast('Erro ao copiar.'); copyButton.innerHTML = originalContent; copyButton.disabled = false; }); }
function limparAnotacoes() { showConfirmModal({ title: "Limpar Anotações?", message: "Tem certeza que deseja apagar todo o conteúdo? Esta ação não pode ser desfeita.", confirmText: "Limpar", onConfirm: () => { document.getElementById('anotacoes-textarea').value = ''; salvarAnotacoesAutomatico(); toast("Anotações limpas."); } }); }
function switchToScreen(screenId, title) { if (!document.getElementById(screenId) || document.getElementById(screenId).classList.contains('active')) return; closeAllModals(); const headerTitle = document.getElementById('main-header-title'); const subMenuScreens = ['screen-fornecedores', 'screen-pedidos', 'screen-observacoes', 'screen-personalizacao']; document.getElementById('sync-btn').style.display = subMenuScreens.includes(screenId) ? 'none' : 'flex'; document.getElementById('close-btn').style.display = subMenuScreens.includes(screenId) ? 'flex' : 'none'; headerTitle.classList.add('title-changing'); setTimeout(() => { headerTitle.textContent = title; headerTitle.classList.remove('title-changing'); }, 175); document.querySelectorAll('.app-screen.active').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); const parentScreenId = screenParentMap[screenId] || screenId; document.querySelectorAll('.tab-item, .sidebar-item').forEach(item => { item.classList.toggle('active', item.dataset.screen === parentScreenId); }); }
function closeAllModals() { document.querySelectorAll('.modal-screen.active').forEach(modal => modal.classList.remove('active')) }
function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(() => t.style.display = 'none', 2000) }
function sincronizarManualmente(button) { if (button.disabled) return; button.disabled = true; const icon = button.querySelector('.icon-wrapper i, .icon-wrapper svg'); if (icon) icon.classList.add('fa-spin'); toast("Sincronizando..."); setTimeout(() => { toast("✓ Dados atualizados com sucesso."); button.disabled = false; if (icon) { icon.classList.remove('fa-spin'); icon.classList.add('sync-success'); setTimeout(() => icon.classList.remove('sync-success'), 800) } }, 1250) }
function showConfirmModal({ title, message, confirmText = "Confirmar", confirmClass = "danger", onConfirm }) { const modal = document.getElementById('confirm-modal'); document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message; const confirmBtn = document.getElementById('confirm-btn'); confirmBtn.textContent = confirmText; confirmBtn.style.backgroundColor = confirmClass === 'danger' ? 'var(--button-danger)' : 'var(--button-success)'; const cancelBtn = document.getElementById('cancel-btn'); const confirmHandler = () => { onConfirm(); closeAllModals(); cleanup() }; const cancelHandler = () => { closeAllModals(); cleanup() }; const cleanup = () => { confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler) }; confirmBtn.addEventListener('click', confirmHandler); cancelBtn.addEventListener('click', cancelHandler); modal.classList.add('active') }
function toggleEditPanel(btn, notaId) { const notaItem = btn.closest('.nota-item'); const editPanel = notaItem.querySelector('.edit-panel'); document.querySelectorAll('.edit-panel.show').forEach(p => { if (p !== editPanel) p.classList.remove('show') }); const isVisible = editPanel.classList.toggle('show'); if (isVisible && editPanel.innerHTML === '') { reconstruirPainelFotosEdit(notaId) } }
async function compartilharNota(id) { const nota = notasPendentes.find(n => n.id === id); if (nota.enviada) return toast("Esta nota já foi enviada."); try { toast("Preparando fotos..."); const files = await Promise.all((nota.fotos || []).map(id => getPhotoDB(id))); const validFiles = files.filter(f => f), separador = await gerarImagemSeparadora(nota.fornecedor, nota.nf); const filesToShare = [new File([separador], 'separador.png', { type: 'image/png' }), ...validFiles]; if (navigator.share) await navigator.share({ files: filesToShare, text: `${nota.fornecedor} ${nota.nf || ''}` }); else return toast("Compartilhamento não suportado."); await Promise.all((nota.fotos || []).map(id => deletePhotoDB(id))); await firestoreRefs.notas.doc(id).update({ enviada: true, fotos: [] }); toast("✓ Nota compartilhada e fotos locais removidas!") } catch (error) { if (error.name !== 'AbortError') toast("Erro ao compartilhar.") } }
function toggleChecklist(btn, notaId) { const notaItem = btn.closest('.nota-item'); const checklistContainer = notaItem.querySelector('.checklist-container'); const editPanel = notaItem.querySelector('.edit-panel'); document.querySelectorAll('.edit-panel.show, .checklist-container.show').forEach(p => { if (p !== checklistContainer) p.classList.remove('show') }); if (editPanel.classList.contains('show')) editPanel.classList.remove('show'); checklistContainer.classList.toggle('show') }
function gerarHtmlChecklist(nota) { let html = ''; const checklistData = nota.checklist || {}; for (const key in checklistDefinition) { const isChecked = checklistData[key] ? 'checked' : ''; html += `<div class="checklist-item"><input type="checkbox" id="check-${key}-${nota.id}" ${isChecked}><label for="check-${key}-${nota.id}">${checklistDefinition[key]}</label></div>` } return html; }
function atualizarChecklist(notaId, tarefa, isChecked) { isChecklistUpdate = true; const updateData = {}; updateData[`checklist.${tarefa}`] = isChecked; firestoreRefs.notas.doc(notaId).update(updateData).catch(error => toast("Erro ao salvar progresso.")); const nota = notasPendentes.find(n => n.id === notaId); if (!nota) return; if (!nota.checklist) nota.checklist = {}; nota.checklist[tarefa] = isChecked; const totalTasks = Object.keys(checklistDefinition).length; const completedTasks = Object.values(nota.checklist).filter(Boolean).length; const progressPercent = (completedTasks / totalTasks) * 100; const notaItemEl = document.querySelector(`div[data-note-id="${notaId}"]`); if (notaItemEl) { const progressBar = notaItemEl.querySelector('.progress-bar'); const progressButton = notaItemEl.querySelector('.progress-btn'); if (progressBar) progressBar.style.width = `${progressPercent}%`; if (progressButton) progressButton.textContent = `Progresso: ${completedTasks}/${totalTasks}` } }
function handleSnapshotChanges(snapshot) { const newNotas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); notasPendentes = newNotas; rebuildNotasPendentesList(); DOM.saida.value = buildSaidaText() }
function rebuildNotasPendentesList() { if (!DOM.listaNotas) return; const createNotaHTML = nota => { let shareBtnHTML; if (nota.enviada) { shareBtnHTML = `<button class="sent-btn icon-only" title="Enviada">${checkmarkSVG}</button>` } else if (nota.fotos?.length > 0) { shareBtnHTML = `<button class="whatsapp-btn icon-only" data-action="share"><i class="fab fa-whatsapp"></i></button>` } else { shareBtnHTML = `<span class="sem-fotos">SEM FOTOS</span>` } const totalTasks = Object.keys(checklistDefinition).length; const completedTasks = nota.checklist ? Object.values(nota.checklist).filter(Boolean).length : 0; const progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0; return `<div class="nota-info">${escapeHTML(nota.fornecedor)} ${escapeHTML(nota.nf || '')}</div><div class="nota-data">Criada em: ${(new Date(nota.dataCriacao)).toLocaleString('pt-BR')}</div><div class="nota-detalhes">Venc: ${escapeHTML(nota.vencimento || 'N/A')} | Valor: ${escapeHTML(nota.valor || 'N/A')}</div><div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div><div class="actions-row"><div class="actions-group"><button class="progress-btn" data-action="toggle-checklist">Progresso: ${completedTasks}/${totalTasks}</button></div><div class="actions-group">${shareBtnHTML}<button class="edit-btn icon-only" data-action="toggle-edit"><span class="icon-wrapper"><i class="fa-solid fa-pen"></i><span class="material-icons">edit</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M21 20H3v-2h18v2zm-4.6-7.4L7 19l-4 1 1-4 9.4-9.4a2.121 2.121 0 0 1 3 3z"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L19 7l-3-3 1.5-1.5z"/></svg></span></button><button class="delete-btn icon-only" data-action="delete"><span class="icon-wrapper"><i class="fa-solid fa-trash"></i><span class="material-icons">delete</span><svg class="icon-svg-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg><svg class="icon-svg-duotone" viewBox="0 0 24 24" fill="currentColor"><path opacity="0.4" d="M5 6h14v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6z"/><path d="M9 4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2H9V4zM3 6h18v2H3V6z"/></svg></span></button></div></div><div class="edit-panel"></div><div class="checklist-container"><div class="panel-content">${gerarHtmlChecklist(nota)}</div></div>` }; if (notasPendentes.length === 0) { DOM.listaNotas.innerHTML = `<div class="empty-state">Nenhuma nota pendente.</div>`; return } const domNoteIds = new Set(Array.from(DOM.listaNotas.children).map(li => li.dataset.noteId)); const newNoteIds = new Set(notasPendentes.map(n => n.id)); for (const id of domNoteIds) { if (!newNoteIds.has(id)) { const el = DOM.listaNotas.querySelector(`div[data-note-id="${id}"]`); if (el) el.remove() } }
notasPendentes.forEach((nota, index) => { const existingEl = DOM.listaNotas.querySelector(`div[data-note-id="${nota.id}"]`); const newHTML = createNotaHTML(nota); if (existingEl) { if (existingEl.innerHTML !== newHTML) { existingEl.innerHTML = newHTML; existingEl.className = `nota-item ${nota.enviada ? 'nota-enviada' : ''}`; if (!document.hidden) existingEl.classList.add('highlight-update') } } else { const div = document.createElement('div'); div.className = `nota-item`; div.dataset.noteId = nota.id; div.innerHTML = newHTML; const referenceNode = DOM.listaNotas.children[index]; DOM.listaNotas.insertBefore(div, referenceNode || null); if (!document.hidden) div.classList.add('highlight-update') } }) }
function popularListaHistorico() { DOM.listaHistorico.innerHTML = ''; if (historicoNotas.length === 0) { DOM.listaHistorico.innerHTML = `<div class="empty-state">O histórico está vazio.</div>`; DOM.historicoActions.style.display = 'none' } else { DOM.historicoActions.style.display = 'grid'; historicoNotas.forEach(nota => { const div = document.createElement('div'); div.classList.add('nota-item'); div.innerHTML = `<div class="nota-info">${escapeHTML(nota.fornecedor)} ${escapeHTML(nota.nf || '')}</div><div class="nota-detalhes">Venc: ${escapeHTML(nota.vencimento || 'N/A')} | Valor: ${escapeHTML(nota.valor || 'N/A')} | Obs: ${escapeHTML(nota.obs || 'N/A')}</div><div class="nota-data">Arquivado em: ${nota.dataHistorico}</div>`; DOM.listaHistorico.appendChild(div) }) } }
function reconstruirMiniaturasAcumuladas() { DOM.miniaturas.innerHTML = ''; fotosAcumuladas.forEach((file, i) => { const w = document.createElement('div'), img = document.createElement('img'), btn = document.createElement('button'); w.className = 'miniatura-wrapper'; img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src); img.onclick = () => abrirPreview(fotosAcumuladas, i, { type: 'nova' }); btn.className = 'remove-foto'; btn.innerHTML = '×'; btn.onclick = e => { e.stopPropagation(); fotosAcumuladas.splice(i, 1); reconstruirMiniaturasAcumuladas() }; w.append(img, btn); DOM.miniaturas.appendChild(w) }) }
async function reconstruirPainelFotosEdit(notaId) { const nota = notasPendentes.find(n => n.id === notaId); if (!nota) return; const painelEdicao = document.querySelector(`div[data-note-id="${notaId}"] .edit-panel`); painelEdicao.innerHTML = `<div class="panel-content"><div class="campo"><label>Fornecedor</label><input type="text" class="fornEdit" value="${escapeHTML(nota.fornecedor || '')}"></div><div class="campo"><label>NF</label><input type="text" class="nfEdit" value="${escapeHTML(nota.nf || '')}"></div><div class="campo"><label>Vencimento</label><input type="text" class="vencEdit" value="${escapeHTML(nota.vencimento || '')}"></div><div class="campo"><label>Valor</label><input type="text" class="valorEdit" value="${escapeHTML(nota.valor || '')}"></div><div class="campo"><label>Observações</label><select class="obsEdit">${DOM.obs.innerHTML}</select></div><div class="campo fotos-edit-container"></div><div class="actions"><button class="actions-button" style="background:var(--button-success);"><span class="icon-wrapper"><i class="fa-solid fa-save"></i></span> Salvar</button></div></div>`; painelEdicao.querySelector('.obsEdit').value = nota.obs || ''; const container = painelEdicao.querySelector('.fotos-edit-container'); if (nota.enviada) { container.innerHTML = `<label>Anexos</label><div class="fotos-enviadas-status">${checkmarkSVG} Fotos já enviadas!</div>` } else { container.innerHTML = `<label>Anexar/Remover Fotos</label><div class="anexo-actions"><label for="edit-fotos-${notaId}" class="file-input-label"><i class="fa-solid fa-image"></i> Selecionar</label><label for="edit-camera-${notaId}" class="file-input-label"><i class="fa-solid fa-camera"></i> Câmera</label></div><input type="file" id="edit-fotos-${notaId}" class="edit-file-input" multiple accept="image/*" /><input type="file" id="edit-camera-${notaId}" class="edit-file-input" accept="image/*" capture="environment" /><div class="miniaturas-container-edit"></div>`; const handleEditFiles = async e => { const files = e.target.files; const newIds = await Promise.all(Array.from(files).map(f => savePhotoDB(generateUniqueId(), f))); const currentNota = notasPendentes.find(n => n.id === notaId); await firestoreRefs.notas.doc(notaId).update({ fotos: [...(currentNota.fotos || []), ...newIds] }); toast(`${files.length} foto(s) adicionada(s).`); e.target.value = null }; container.querySelector(`#edit-fotos-${notaId}`).addEventListener('change', handleEditFiles); container.querySelector(`#edit-camera-${notaId}`).addEventListener('change', handleEditFiles); reconstruirMiniaturasEdit(notaId) } }
async function reconstruirMiniaturasEdit(notaId) { const nota = notasPendentes.find(n => n.id === notaId); if (!nota || !nota.fotos) return; const container = document.querySelector(`div[data-note-id="${notaId}"] .miniaturas-container-edit`); if (!container) return; container.innerHTML = ''; const files = await Promise.all(nota.fotos.map(id => getPhotoDB(id).catch(() => null))); nota.fotos.forEach((photoId, i) => { const file = files[i], wrapper = document.createElement('div'); wrapper.className = 'miniatura-wrapper'; if (file) { const img = document.createElement('img'), btn = document.createElement('button'); img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src); const fileIndexInThumbnails = files.filter(f => f).indexOf(file); img.onclick = () => abrirPreview(files.filter(f => f), fileIndexInThumbnails, { type: 'nota', id: notaId, photoId: photoId }); btn.className = 'remove-foto'; btn.innerHTML = '×'; btn.onclick = e => { e.stopPropagation(); removerFotoEdit(notaId, i) }; wrapper.append(img, btn) } else { wrapper.innerHTML = `<div class="not-found"><i class="fa-solid fa-ghost"></i></div>` } container.appendChild(wrapper) }) }
async function removerFotoEdit(notaId, fIndex) { showConfirmModal({ title: "Remover Imagem?", message: "Deseja remover esta imagem da nota?", onConfirm: async () => { const nota = notasPendentes.find(n => n.id === notaId); const photoId = nota.fotos[fIndex], updatedIds = nota.fotos.filter((_, i) => i !== fIndex); await firestoreRefs.notas.doc(nota.id).update({ fotos: updatedIds }); await deletePhotoDB(photoId); toast("Imagem removida.") } }) }
async function adicionarFornecedor(forn, noToast = false) { const f = forn.trim().toUpperCase(); if (f && !appConfig.fornecedores.includes(f)) { appConfig.fornecedores.push(f); await firestoreRefs.config.set({ fornecedores: appConfig.fornecedores }, { merge: true }); if (!noToast) toast(`Fornecedor ${f} adicionado!`); } }
async function adicionarFornecedorManage() { const f = DOM.fornManageInput.value.trim(); if (f) { await adicionarFornecedor(f); DOM.fornManageInput.value = '' } }
async function deletarFornecedor(f) { showConfirmModal({ title: "Excluir Fornecedor", message: `Tem certeza que deseja excluir o fornecedor "${f}"?`, onConfirm: async () => { appConfig.fornecedores = appConfig.fornecedores.filter(item => item !== f); await firestoreRefs.config.update({ fornecedores: firebase.firestore.FieldValue.arrayRemove(f) }); toast(`Fornecedor ${f} excluído.`) } }) }
function popularDatalist() { DOM.fornDatalist.innerHTML = ''; appConfig.fornecedores.sort().forEach(f => DOM.fornDatalist.innerHTML += `<option value="${escapeHTML(f)}"></option>`); popularListaFornecedores() }
function popularListaFornecedores() { DOM.listaFornManage.innerHTML = ''; appConfig.fornecedores.sort().forEach(f => DOM.listaFornManage.innerHTML += `<li>${escapeHTML(f)} <button><i class="fa-solid fa-times-circle"></i></button></li>`) }
async function adicionarObservacao(obs, noToast = false) { const o = obs.trim(); if (o && !appConfig.observacoes.includes(o)) { appConfig.observacoes.push(o); await firestoreRefs.config.set({ observacoes: appConfig.observacoes }, { merge: true }); if (!noToast) toast(`Observação "${o}" adicionada!`) } }
function adicionarObservacaoManage() { const o = DOM.obsManageInput.value.trim(); if (o) { adicionarObservacao(o); DOM.obsManageInput.value = '' } }
async function deletarObservacao(o) { showConfirmModal({ title: "Excluir Observação", message: `Tem certeza que deseja excluir a observação "${o}"?`, onConfirm: async () => { appConfig.observacoes = appConfig.observacoes.filter(i => i !== o); await firestoreRefs.config.update({ observacoes: firebase.firestore.FieldValue.arrayRemove(o) }); toast(`Observação "${o}" excluída.`) } }) }
function popularObservacoesList() { DOM.obs.innerHTML = '<option value="">Recurso a ser pago</option>'; appConfig.observacoes.sort().forEach(o => DOM.obs.innerHTML += `<option value="${escapeHTML(o)}">${escapeHTML(o)}</option>`); DOM.listaObsManage.innerHTML = ''; appConfig.observacoes.sort().forEach(o => DOM.listaObsManage.innerHTML += `<li>${escapeHTML(o)} <button>Excluir</button></li>`) }
async function adicionarPedido() { const pNum = DOM.pedidoNumInput.value.trim(); const r = DOM.pedidoRecursoSelect.value; if (!pNum || !r) { return toast('Preencha o pedido e o recurso.'); } const updateData = {}; updateData[`pedidosRecursos.${pNum}`] = r; DOM.pedidoNumInput.value = ''; DOM.pedidoRecursoSelect.value = ''; try { await firestoreRefs.config.update(updateData); toast(`✓ Pedido ${pNum} adicionado!`); } catch (error) { if (error.code === 'not-found') { await firestoreRefs.config.set({ pedidosRecursos: { [pNum]: r } }, { merge: true }); toast(`✓ Pedido ${pNum} adicionado!`); } else { console.error("Erro ao adicionar pedido:", error); toast(`✕ Falha ao adicionar o pedido ${pNum}.`); } } }
async function deletarPedido(p) { showConfirmModal({ title: "Excluir Pedido", message: `Tem certeza que deseja excluir o pedido "${p}"?`, onConfirm: async () => { const updateData = {}; updateData[`pedidosRecursos.${p}`] = firebase.firestore.FieldValue.delete(); try { await firestoreRefs.config.update(updateData); toast(`Pedido ${p} excluído.`); } catch (error) { console.error("Erro ao deletar pedido:", error); toast(`✕ Falha ao excluir o pedido ${p}.`); } } }); }
function popularListaPedidos() { DOM.listaPedidos.innerHTML = ''; const pedidosOrdenados = Object.keys(appConfig.pedidosRecursos).sort((a, b) => Number(a) - Number(b)); pedidosOrdenados.forEach(p => { DOM.listaPedidos.innerHTML += `<li>${escapeHTML(p)} - ${escapeHTML(appConfig.pedidosRecursos[p])} <button><i class="fa-solid fa-times-circle"></i></button></li>` }) }
function formatarDataInput(input) { let v = input.value.replace(/\D/g, '').substring(0, 8); if (v.length > 4) v = `${v.slice(0, 2)}/${v.slice(2, 4)}/${v.slice(4)}`; else if (v.length > 2) v = `${v.slice(0, 2)}/${v.slice(2)}`; input.value = v }
function formatarValorBlur(event) { let v = event.target.value.replace(/\./g, '').replace(',', '.').replace(/[^\d.]/g, ''); if (v) event.target.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }
function getLinha(nota) { let v = nota.vencimento, o = nota.obs; if (nota.obs === "REMESSA") { v = "REMESSA"; o = "Recurso Proprio Santa Casa" } return [nota.data, nota.nf, v, nota.valor, "", nota.fornecedor, "", "", o].join("\t") }
function buildSaidaText() { return notasPendentes.map(getLinha).join("\n") }
async function exportar() { if (DOM.saida.value === "") return toast("Nada para copiar."); await navigator.clipboard.writeText(DOM.saida.value); toast("✓ Lista copiada!") }
async function compartilharLista() { const texto = DOM.saida.value; if (!texto.trim()) return toast("Nada para compartilhar."); if (navigator.share) { await navigator.share({ title: 'Relação de Notas Fiscais', text: texto }) } else { await navigator.clipboard.writeText(texto); toast("Compartilhamento não suportado. Lista copiada!") } }
function limparFormularioPrincipal(comFoco = true) { document.querySelector('#screen-add').scrollTo({ top: 0, behavior: 'smooth' }); const today = new Date; DOM.data.value = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;[DOM.nf, DOM.venc, DOM.valor, DOM.forn, DOM.obs].forEach(el => el.value = ""); fotosAcumuladas = []; reconstruirMiniaturasAcumuladas(); const salvarBtn = document.getElementById('salvarBtn'); salvarBtn.innerHTML = `<span class="icon-wrapper"><i class="fa-solid fa-save"></i></span> Salvar`; if (comFoco) setTimeout(() => DOM.nf.focus(), 350) }
async function abrirPreview(fotos, index, contexto) { const modal = document.getElementById('modalPreview'), imgPreview = document.getElementById('imgPreview'); fotosAtuaisParaPreview = fotos; fotoAtualIndex = index; fotoAtualContexto = contexto; const file = fotos[index]; if (file) { imgPreview.src = URL.createObjectURL(file); imgPreview.onload = () => URL.revokeObjectURL(imgPreview.src) } modal.style.display = 'flex'; document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none'; document.getElementById('nextBtn').style.display = index < fotos.length - 1 ? 'block' : 'none' }
function fecharPreview() { document.getElementById('modalPreview').style.display = 'none'; const imgPreview = document.getElementById('imgPreview'); if (imgPreview.src.startsWith('blob:')) URL.revokeObjectURL(imgPreview.src); imgPreview.src = '' }
function navegarFotos(dir) { const novoIndex = fotoAtualIndex + dir; if (novoIndex >= 0 && novoIndex < fotosAtuaisParaPreview.length) { abrirPreview(fotosAtuaisParaPreview, novoIndex, fotoAtualContexto) } }
async function salvarFotoPreview() { if (!fotosAtuaisParaPreview || fotosAtuaisParaPreview.length === 0) return toast("Nenhuma imagem para salvar."); const file = fotosAtuaisParaPreview[fotoAtualIndex]; if (!file) return toast("Arquivo de imagem não encontrado."); try { if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: file.name || `nota_fiscal_${Date.now()}.png` }) } else { const a = document.createElement('a'); a.style.display = 'none'; a.href = URL.createObjectURL(file); a.download = file.name || `nota_fiscal_${Date.now()}.png`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(a.href); document.body.removeChild(a); toast("Download iniciado!") } } catch (error) { console.error("Erro ao salvar/compartilhar a imagem:", error); if (error.name !== 'AbortError') { toast("Falha ao compartilhar a imagem.") } } }
async function excluirFotoPreview() { showConfirmModal({ title: "Excluir Imagem?", message: "Tem certeza que deseja excluir esta imagem?", onConfirm: async () => { if (fotoAtualContexto.type === 'nova') { fotosAcumuladas.splice(fotoAtualIndex, 1); reconstruirMiniaturasAcumuladas() } else if (fotoAtualContexto.type === 'nota') { const nota = notasPendentes.find(n => n.id === fotoAtualContexto.id); const photoIndexInNota = nota.fotos.indexOf(fotoAtualContexto.photoId); if (photoIndexInNota > -1) await removerFotoEdit(fotoAtualContexto.id, photoIndexInNota) } toast("Imagem excluída."); if (fotosAtuaisParaPreview.length <= 1) { fecharPreview() } else { const newIndex = (fotoAtualIndex >= fotosAtuaisParaPreview.length - 1) ? fotoAtualIndex - 1 : fotoAtualIndex; fotosAtuaisParaPreview.splice(fotoAtualIndex, 1); abrirPreview(fotosAtuaisParaPreview, newIndex, fotoAtualContexto) } } }) }
async function gerarImagemSeparadora(fornecedor, nf) { const c = document.createElement('canvas'); c.width = 600; c.height = 150; const ctx = c.getContext('2d'); ctx.fillStyle = '#34495e'; ctx.fillRect(0, 0, 600, 150); ctx.fillStyle = '#ecf0f1'; ctx.font = `bold 30px ${getComputedStyle(document.body).fontFamily}`; ctx.textAlign = 'center'; ctx.fillText(`${fornecedor} ${nf}`, 300, 70); ctx.font = '50px sans-serif'; ctx.fillText(`↓`, 300, 130); return new Promise(r => c.toBlob(r, 'image/png')) }


</script>
</body>
</html>
